<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="board">

    <!-- BoardVo에 맞춘 ResultMap -->
    <resultMap id="boardMap" type="com.bit2025.mysite.vo.BoardVo">
        <id property="no" column="no"/>
        <result property="title" column="title"/>
        <result property="contents" column="contents"/>
        <result property="writer" column="writer"/>
        <result property="viewCount" column="hit"/>
        <result property="depth" column="depth"/>
        <result property="parentId" column="parent_id"/>
        <result property="fileName" column="fileName"/>
        <result property="createdAt" column="reg_date"/>
    </resultMap>

    <!-- 전체 조회 -->
    <select id="findAll" resultMap="boardMap">
        select * from board order by no desc
    </select>

    <!-- 단일 조회 -->
    <select id="findById" parameterType="long" resultMap="boardMap">
        select * from board where no = #{no}
    </select>

    <!-- 새 글 작성 -->
    <insert id="insert" parameterType="com.bit2025.mysite.vo.BoardVo">
        insert into board(title, contents, writer, fileName, hit, reg_date, depth)
        values(#{title}, #{contents}, #{writer}, #{fileName}, 0, now(), 0)
    </insert>

    <!-- 답글 작성 -->
    <insert id="insertReply" parameterType="com.bit2025.mysite.vo.BoardVo">
        insert into board(title, contents, writer, fileName, hit, reg_date, depth, parent_id)
        values(#{title}, #{contents}, #{writer}, #{fileName}, 0, now(), #{depth}, #{parentId})
    </insert>

    <!-- 글 수정 -->
    <update id="update" parameterType="com.bit2025.mysite.vo.BoardVo">
    update board
    set title = #{title},
        contents = #{contents},
        `fileName` = #{fileName}
    where no = #{no}
	</update>

    <!-- 조회수 증가 -->
    <update id="increaseViewCount" parameterType="long">
        update board set hit = hit + 1 where no=#{no}
    </update>

    <!-- 글 삭제 -->
    <delete id="delete" parameterType="long">
        delete from board where no=#{no}
    </delete>

    <!-- 총 글 수 -->
    <select id="getTotalCount" parameterType="string" resultType="int">
        <choose>
            <when test="search != null and search != ''">
                select count(*) from board
                where title like concat('%', #{search}, '%')
                   or contents like concat('%', #{search}, '%')
                   or writer like concat('%', #{search}, '%')
            </when>
            <otherwise>
                select count(*) from board
            </otherwise>
        </choose>
    </select>

    <!-- 페이지 조회 -->
    <select id="findPage" parameterType="map" resultMap="boardMap">
        <choose>
            <when test="search != null and search != ''">
                select * from board
                where title like concat('%', #{search}, '%')
                   or contents like concat('%', #{search}, '%')
                   or writer like concat('%', #{search}, '%')
                order by no desc
                limit #{pageSize} offset #{start}
            </when>
            <otherwise>
                select * from board
                order by no desc
                limit #{pageSize} offset #{start}
            </otherwise>
        </choose>
    </select>

</mapper>
